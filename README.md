# Events Service

[![CI/CD](https://github.com/Verteletsky/events-service/actions/workflows/ci.yml/badge.svg)](https://github.com/Verteletsky/events-service/actions/workflows/ci.yml)

Сервис для управления жизненным циклом событий.

## Описание

Сервис предоставляет API для управления событиями в системе. Он позволяет:

- Создавать новые события
- Получать список событий
- Запускать события
- Завершать события

## Технологии

- Go 1.23.4
- MongoDB
- Docker
- GitHub Actions (CI/CD)

## Требования

- Docker
- Docker Compose
- Go 1.23.4
- MongoDB 6.0 или выше

## Переменные окружения

Сервис поддерживает следующие переменные окружения:

| Переменная         | Описание                      | Значение по умолчанию       |
|--------------------|-------------------------------|-----------------------------|
| `MONGODB_URI`      | URI для подключения к MongoDB | `mongodb://localhost:27017` |
| `MONGODB_DATABASE` | Имя базы данных               | `events`                    |
| `SERVER_PORT`      | Порт HTTP сервера             | `8080`                      |
| `LOG_LEVEL`        | Уровень логирования           | `info`                      |

## Особенности

- Использование MongoDB для хранения данных
- REST API для управления событиями
- Логирование с помощью zap (Uber)
- Graceful shutdown
- Docker контейнеризация
- Валидация входных данных
- Тесты производительности
- Оптимистичная блокировка для предотвращения конфликтов

## Запуск

1. Клонируйте репозиторий:

```bash
git clone https://github.com/Verteletsky/events-service.git
cd events-service
```

2. Создайте файл `.env` (опционально):

```bash
MONGODB_URI=mongodb://localhost:27017
MONGODB_DATABASE=events
SERVER_PORT=8080
LOG_LEVEL=info
```

3. Запустите сервис с помощью Docker Compose:

```bash
docker-compose up -d
```

Сервис будет доступен по адресу: http://localhost:8080

## API Endpoints

### GET /v1

Получение списка событий

Параметры запроса:

- `offset` (опционально) - смещение (по умолчанию 0)
- `limit` (опционально) - количество событий (максимум 100, по умолчанию 100)
- `type` (опционально) - фильтр по типу события

### POST /v1/start

Создание нового события

Тело запроса:

```json
{
  "type": "string"
  // тип события (только строчные буквы и цифры)
}
```

### POST /v1/finish

Завершение существующего события

Тело запроса:

```json
{
  "type": "string"
  // тип события (только строчные буквы и цифры)
}
```

## Валидация

Сервис выполняет следующие проверки:

- Тип события должен соответствовать регулярному выражению `^[a-z0-9]+$`
- Параметр `limit` не может быть больше 100
- Не может быть более одного незавершенного события одного типа

## Тесты

### Unit-тесты

```bash
go test ./... -v
```

### Тесты производительности

Для запуска тестов производительности:

```bash
node load-test.js
```

## Разработка

Для локальной разработки:

1. Установите зависимости:

```bash
go mod download
```

2. Запустите MongoDB:

```bash
docker-compose up -d mongodb
```

3. Запустите сервис:

```bash
go run cmd/main.go
```

## Логирование

Сервис использует zap логгер от Uber для логирования. Логи включают:

- Информацию о запуске и остановке сервиса
- Ошибки при работе с базой данных
- Информацию о создании и завершении событий
- Предупреждения при попытке завершить несуществующее событие

## Оптимизация Docker образа

В процессе разработки были проведены оптимизации Docker образа, что позволило значительно уменьшить его размер:

### Результаты оптимизации

- Исходный размер: 38.7MB
- После первой оптимизации: 16.6MB (уменьшение на ~57%)
- После полной оптимизации: 6.4MB (уменьшение на ~83% от исходного размера)

### Примененные оптимизации

1. **Многоступенчатая сборка**
    - Использование `scratch` вместо `alpine` в финальном образе
    - Минимальное количество слоев

2. **Оптимизация сборки Go**
    - Статическая линковка (`-extldflags=-static`)
    - Удаление путей из бинарника (`-trimpath`)
    - Отключение отладочной информации (`-w -s`)

3. **Сжатие бинарника**
    - Использование `upx` с алгоритмом LZMA
    - Оптимальный уровень сжатия (`--best`)

4. **Исключение ненужных файлов**
    - Использование `.dockerignore`
    - Копирование только необходимых файлов
    - Исключение тестов, документации и временных файлов

### Преимущества оптимизированного образа

- Минимальный размер (6.4MB)
- Быстрая загрузка и развертывание
- Меньше уязвимостей (минимальный базовый образ)
- Эффективное использование ресурсов

## Лицензия

MIT 